<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>CSUF MPA - Exit Survey (Program Dropouts)</title>
    <style>
        * { box-sizing: border-box; margin:0; padding:0; }
        body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial; background:#f5f7fa; color:#222; padding:20px; }
        .container { max-width:820px; margin:0 auto; background:#fff; padding:28px; border-radius:8px; box-shadow:0 6px 20px rgba(0,0,0,0.08); }
        .header { text-align:center; margin-bottom:18px; border-bottom:3px solid #003262; padding-bottom:14px; }
        .header h1 { color:#003262; font-size:22px; margin-bottom:6px; }
        .header p { color:#555; font-size:13px; }
        .intro { background:#eef7ff; padding:14px; border-left:4px solid #003262; border-radius:6px; margin-bottom:18px; font-size:14px; }
        .progress { height:8px; background:#e6e9ee; border-radius:8px; overflow:hidden; margin-bottom:18px; }
        .progress > .bar { height:100%; background:linear-gradient(90deg,#003262,#0066cc); width:0%; transition:width .25s ease; }
        .section { display:none; }
        .section.active { display:block; animation:fadeIn .25s ease; }
        @keyframes fadeIn { from{opacity:0; transform:translateY(8px);} to{opacity:1; transform:none;} }
        .question { margin-bottom:16px; }
        label { display:block; font-weight:600; margin-bottom:6px; color:#222; }
        .required::after { content:" *"; color:#c62828; font-weight:700; margin-left:2px; }
        input[type="text"], input[type="email"], select, textarea { width:100%; padding:10px; border:1px solid #ddd; border-radius:6px; font-size:14px; }
        textarea { min-height:100px; resize:vertical; }
        .radio-group, .checkbox-group { display:flex; flex-direction:column; gap:8px; }
        .option { display:flex; align-items:center; gap:10px; padding:8px; border:1px solid #eef2f6; border-radius:6px; cursor:pointer; }
        .buttons { display:flex; gap:10px; margin-top:18px; border-top:1px solid #eceff3; padding-top:16px; }
        button { padding:10px 16px; border-radius:6px; border:0; font-weight:700; cursor:pointer; }
        .btn-primary { background:#003262; color:#fff; }
        .btn-muted { background:#eef2f6; color:#003262; }
        .btn-success { background:#2e7d32; color:#fff; }
        .error { background:#fff2f2; color:#c62828; padding:10px 12px; border-radius:6px; margin-bottom:12px; display:none; }
        .error.active { display:block; }
        .completion { text-align:center; display:none; padding:24px; }
        .completion.active { display:block; }
        @media (max-width:720px) { .buttons { flex-direction:column; } button { width:100%; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>CSUF MPA — Exit Survey (Early Exit)</h1>
            <p>Your anonymous feedback helps improve retention and student experience.</p>
        </div>

        <div class="intro">
            Please answer the brief questions about why you left the MPA program. This form should take 5 minutes. Fields marked with * are required.
        </div>

        <div class="progress" aria-hidden="true"><div class="bar" id="progressBar"></div></div>

        <div class="error" id="errorMessage"></div>

        <form id="dropoutForm" action="https://formspree.io/f/mkgqekja" method="POST" novalidate>
            <!-- Section 1 -->
            <div class="section active" data-section="1">
                <h2 style="color:#003262; margin-bottom:12px; font-size:18px;">1. Basic info</h2>

                <div class="question">
                    <label>Name (optional)</label>
                    <input type="text" name="name" placeholder="You may leave blank to remain anonymous">
                </div>

                <div class="question">
                    <label>Email (optional)</label>
                    <input type="email" name="email" placeholder="If you'd like follow-up (optional)">
                </div>

                <div class="question">
                    <label class="required">Last term enrolled (e.g., Fall 2024)</label>
                    <input type="text" name="last_term" required>
                </div>

            </div>

            <!-- Section 2 -->
            <div class="section" data-section="2">
                <h2 style="color:#003262; margin-bottom:12px; font-size:18px;">2. Why did you leave?</h2>

                <div class="question">
                    <label class="required">Primary reason for leaving</label>
                    <div class="radio-group">
                        <label class="option"><input type="radio" name="primary_reason" value="financial" required> Financial reasons/cost</label>
                        <label class="option"><input type="radio" name="primary_reason" value="time_conflict" required> Time/work/life conflict</label>
                        <label class="option"><input type="radio" name="primary_reason" value="academic_difficulty" required> Academic difficulty</label>
                        <label class="option"><input type="radio" name="primary_reason" value="program_mismatch" required> Program didn't meet expectations</label>
                        <label class="option"><input type="radio" name="primary_reason" value="advising_issues" required> Advising / administrative issues</label>
                        <label class="option"><input type="radio" name="primary_reason" value="health_personal" required> Health / personal reasons</label>
                        <label class="option"><input type="radio" name="primary_reason" value="other" required> Other (please specify)</label>
                    </div>
                    <input type="text" name="primary_reason_other" id="primaryOther" placeholder="If other, please specify" style="margin-top:10px; display:none;">
                </div>

                <div class="question">
                    <label>Were financial aid/scholarships a factor?</label>
                    <div class="radio-group">
                        <label class="option"><input type="radio" name="financial_aid_factor" value="yes"> Yes</label>
                        <label class="option"><input type="radio" name="financial_aid_factor" value="no"> No</label>
                        <label class="option"><input type="radio" name="financial_aid_factor" value="somewhat"> Somewhat</label>
                    </div>
                </div>
            </div>

            <!-- Section 3 -->
            <div class="section" data-section="3">
                <h2 style="color:#003262; margin-bottom:12px; font-size:18px;">3. Program experience</h2>

                <div class="question">
                    <label class="required">Rate these areas (Excellent / Good / Fair / Poor)</label>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                        <div>
                            <label style="font-weight:600; margin-bottom:6px;">Course quality</label>
                            <select name="rate_course_quality" required>
                                <option value="">Select</option>
                                <option value="excellent">Excellent</option>
                                <option value="good">Good</option>
                                <option value="fair">Fair</option>
                                <option value="poor">Poor</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-weight:600; margin-bottom:6px;">Faculty support</label>
                            <select name="rate_faculty_support" required>
                                <option value="">Select</option>
                                <option value="excellent">Excellent</option>
                                <option value="good">Good</option>
                                <option value="fair">Fair</option>
                                <option value="poor">Poor</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-weight:600; margin-bottom:6px;">Advising / admin</label>
                            <select name="rate_advising" required>
                                <option value="">Select</option>
                                <option value="excellent">Excellent</option>
                                <option value="good">Good</option>
                                <option value="fair">Fair</option>
                                <option value="poor">Poor</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-weight:600; margin-bottom:6px;">Program fit</label>
                            <select name="rate_program_fit" required>
                                <option value="">Select</option>
                                <option value="excellent">Excellent</option>
                                <option value="good">Good</option>
                                <option value="fair">Fair</option>
                                <option value="poor">Poor</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="question">
                    <label>Briefly describe any key issue that influenced your decision (optional)</label>
                    <textarea name="key_issue" placeholder="Example: scheduling conflicts with work, unexpected costs, etc."></textarea>
                </div>
            </div>

            <!-- Section 4 -->
            <div class="section" data-section="4">
                <h2 style="color:#003262; margin-bottom:12px; font-size:18px;">4. Suggestions & next steps</h2>

                <div class="question">
                    <label class="required">What could the program change to help retain students like you?</label>
                    <textarea name="suggestions" required></textarea>
                </div>

                <div class="question">
                    <label>Are you interested in being contacted to discuss your experience?</label>
                    <div class="radio-group">
                        <label class="option"><input type="radio" name="contact_ok" value="yes"> Yes — you may contact me</label>
                        <label class="option"><input type="radio" name="contact_ok" value="no"> No — please do not contact</label>
                    </div>
                </div>

                <div class="question" id="contactDetails" style="display:none;">
                    <div style="background:#f0f7ff; padding:12px; border-left:4px solid #003262; border-radius:6px; margin-bottom:12px;">
                        <strong>Contact Information</strong> — Please provide your details for follow-up:
                    </div>
                    
                    <div class="question" id="contactNameField" style="display:none;">
                        <label class="required">Name</label>
                        <input type="text" name="contact_name" placeholder="Your name for follow-up">
                    </div>

                    <div class="question" id="contactEmailField" style="display:none;">
                        <label class="required">Email</label>
                        <input type="email" name="contact_email" placeholder="Your email for follow-up">
                    </div>
                </div>

                <div style="background:#f0f7ff; padding:12px; border-left:4px solid #003262; border-radius:6px; margin-top:12px;">
                    <strong>Thank you.</strong> Submitting this form will send the responses to the program staff. You can also download a copy before submitting.
                </div>
            </div>

            <div class="buttons">
                <button type="button" class="btn-muted" id="prevBtn" style="display:none;">Previous</button>
                <button type="button" class="btn-primary" id="nextBtn">Next</button>
                <button type="button" class="btn-success" id="submitBtn" style="display:none;">Submit</button>
                <button type="button" class="btn-muted" id="downloadBtn" style="margin-left:auto;">Download CSV</button>
            </div>
        </form>

        <div class="completion" id="completionMessage">
            <h2 style="color:#2e7d32;">✓ Thank you — Response recorded</h2>
            <p style="color:#555;">We appreciate your feedback. If you agreed to be contacted, someone may follow up.</p>
            <button class="btn-success" id="completionDownload">Download Responses (CSV)</button>
        </div>
    </div>

    <script>
        // Shortened navigation & submission logic
        let current = 1;
        const total = 4;
        const data = {};

        document.addEventListener('DOMContentLoaded', () => {
            updateProgress();
            setup();
        });

        function setup() {
            document.getElementById('nextBtn').addEventListener('click', () => {
                if (validateSection()) {
                    saveSection();
                    if (current < total) { current++; showSection(current); updateProgress(); }
                }
            });

            document.getElementById('prevBtn').addEventListener('click', () => {
                if (current > 1) { saveSection(); current--; showSection(current); updateProgress(); }
            });

            document.getElementById('submitBtn').addEventListener('click', () => {
                if (validateSection()) {
                    saveSection();
                    submitForm();
                }
            });

            document.getElementById('downloadBtn').addEventListener('click', downloadCSV);
            document.getElementById('completionDownload').addEventListener('click', downloadCSV);

            // show/hide "other" input
            document.querySelectorAll('input[name="primary_reason"]').forEach(r => {
                r.addEventListener('change', () => {
                    const other = document.getElementById('primaryOther');
                    if (r.value === 'other' && r.checked) { other.style.display = 'block'; other.required = true; }
                    else if (!document.querySelector('input[name="primary_reason"][value="other"]')?.checked) { other.style.display = 'none'; other.value=''; other.required = false; }
                });
            });
            
            // show/hide contact details based on contact_ok selection
            document.querySelectorAll('input[name="contact_ok"]').forEach(r => {
                r.addEventListener('change', () => {
                    const contactDetails = document.getElementById('contactDetails');
                    const contactNameField = document.getElementById('contactNameField');
                    const contactEmailField = document.getElementById('contactEmailField');
                    const nameInput = document.querySelector('input[name="contact_name"]');
                    const emailInput = document.querySelector('input[name="contact_email"]');
                    
                    if (r.value === 'yes' && r.checked) {
                        contactDetails.style.display = 'block';
                        
                        // Check if name/email were provided in section 1
                        const originalName = document.querySelector('input[name="name"]').value.trim();
                        const originalEmail = document.querySelector('input[name="email"]').value.trim();
                        
                        // Show name field if not provided originally
                        if (!originalName) {
                            contactNameField.style.display = 'block';
                            nameInput.required = true;
                        } else {
                            contactNameField.style.display = 'none';
                            nameInput.required = false;
                            nameInput.value = '';
                        }
                        
                        // Show email field if not provided originally
                        if (!originalEmail) {
                            contactEmailField.style.display = 'block';
                            emailInput.required = true;
                        } else {
                            contactEmailField.style.display = 'none';
                            emailInput.required = false;
                            emailInput.value = '';
                        }
                    } else {
                        contactDetails.style.display = 'none';
                        nameInput.required = false;
                        emailInput.required = false;
                        nameInput.value = '';
                        emailInput.value = '';
                    }
                });
            });
        }

        function showSection(n) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            const el = document.querySelector(`.section[data-section="${n}"]`);
            if (el) el.classList.add('active');
            document.getElementById('prevBtn').style.display = n>1 ? 'inline-block' : 'none';
            document.getElementById('nextBtn').style.display = n<total ? 'inline-block' : 'none';
            document.getElementById('submitBtn').style.display = n===total ? 'inline-block' : 'none';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function updateProgress() {
            const pct = (current / total) * 100;
            document.getElementById('progressBar').style.width = pct + '%';
        }

        function validateSection() {
            const sec = document.querySelector(`.section[data-section="${current}"]`);
            const reqs = Array.from(sec.querySelectorAll('[required]'));
            let ok = true;
            let first = null;

            hideError();
            reqs.forEach(f => {
                // ignore hidden
                if (f.offsetParent === null) return;
                if (f.type === 'radio') {
                    const group = sec.querySelectorAll(`[name="${f.name}"]`);
                    const checked = Array.from(group).some(r => r.checked);
                    if (!checked) { ok = false; if (!first) first = f; }
                } else if (!String(f.value || '').trim()) {
                    ok = false; if (!first) first = f;
                    f.style.borderColor = '#c62828';
                } else {
                    f.style.borderColor = '#ddd';
                }
            });

            if (!ok) {
                showError('Please complete all required fields on this page before continuing.');
                if (first) first.scrollIntoView({ behavior: 'smooth', block:'center' });
            }
            return ok;
        }

        function saveSection() {
            const sec = document.querySelector(`.section[data-section="${current}"]`);
            const inputs = sec.querySelectorAll('input,select,textarea');
            inputs.forEach(i => {
                if (!i.name) return;
                if (i.type === 'radio') {
                    if (i.checked) data[i.name] = i.value;
                } else if (i.type === 'checkbox') {
                    if (!data[i.name]) data[i.name] = [];
                    if (i.checked) data[i.name].push(i.value);
                } else {
                    data[i.name] = i.value;
                }
            });
            
            // If contact fields were filled, use them as the primary contact info
            if (data.contact_name && data.contact_name.trim()) {
                data.name = data.contact_name;
            }
            if (data.contact_email && data.contact_email.trim()) {
                data.email = data.contact_email;
            }
        }

        function submitForm() {
            // timestamp
            data.submission_date = new Date().toISOString();

            // prepare FormData
            const fd = new FormData();
            for (const k in data) {
                let v = data[k];
                if (Array.isArray(v)) v = v.join('; ');
                fd.append(k, v);
            }

            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true; submitBtn.textContent = 'Submitting...';

            fetch('https://formspree.io/f/mkgqekja', {
                method: 'POST',
                body: fd,
                headers: { 'Accept': 'application/json' }
            }).then(res => {
                if (res.ok) {
                    document.getElementById('dropoutForm').style.display = 'none';
                    document.querySelector('.progress').style.display = 'none';
                    document.getElementById('completionMessage').classList.add('active');
                } else {
                    return res.json().then(j => { throw j; });
                }
            }).catch(() => {
                showError('Submission failed. You can download your responses and email them to program staff.');
                submitBtn.disabled = false; submitBtn.textContent = 'Submit';
            });
        }

        function convertToCSV(obj) {
            let csv = 'Field,Value\n';
            for (const k in obj) {
                let v = obj[k];
                if (Array.isArray(v)) v = v.join('; ');
                v = String(v || '').replace(/"/g,'""');
                if (v.includes(',')||v.includes('\n')) v = `"${v}"`;
                csv += `"${k}","${v}"\n`;
            }
            return csv;
        }

        function downloadCSV() {
            // ensure latest section saved
            saveSection();
            data.submission_backups = 'local_copy';
            const csv = convertToCSV(data);
            const blob = new Blob([csv], { type:'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'mpa_exit_dropout_' + Date.now() + '.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function showError(msg) {
            const e = document.getElementById('errorMessage');
            e.textContent = msg; e.classList.add('active'); e.scrollIntoView({ behavior:'smooth', block:'center' });
        }
        function hideError() {
            const e = document.getElementById('errorMessage'); e.classList.remove('active');
        }
    </script>
</body>
</html>