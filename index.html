<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>CSUF MPA - Exit Survey (Program Dropouts)</title>
    <style>
        * { box-sizing: border-box; margin:0; padding:0; }
        body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial; background:#f5f7fa; color:#222; padding:20px; }
        .container { max-width:820px; margin:0 auto; background:#fff; padding:28px; border-radius:8px; box-shadow:0 6px 20px rgba(0,0,0,0.08); }
        .header { text-align:center; margin-bottom:18px; border-bottom:3px solid #003262; padding-bottom:14px; }
        .header h1 { color:#003262; font-size:22px; margin-bottom:6px; }
        .header p { color:#555; font-size:13px; }
        .intro { background:#eef7ff; padding:14px; border-left:4px solid #003262; border-radius:6px; margin-bottom:18px; font-size:14px; }
        .progress { height:8px; background:#e6e9ee; border-radius:8px; overflow:hidden; margin-bottom:18px; }
        .progress > .bar { height:100%; background:linear-gradient(90deg,#003262,#0066cc); width:0%; transition:width .25s ease; }
        .section { display:none; }
        .section.active { display:block; animation:fadeIn .25s ease; }
        @keyframes fadeIn { from{opacity:0; transform:translateY(8px);} to{opacity:1; transform:none;} }
        .question { margin-bottom:16px; }
        label { display:block; font-weight:600; margin-bottom:6px; color:#222; }
        .required::after { content:" *"; color:#c62828; font-weight:700; margin-left:2px; }
        input[type="text"], input[type="email"], select, textarea { width:100%; padding:10px; border:1px solid #ddd; border-radius:6px; font-size:14px; }
        textarea { min-height:100px; resize:vertical; }
        .radio-group, .checkbox-group { display:flex; flex-direction:column; gap:8px; }
        .option { display:flex; align-items:center; gap:10px; padding:8px; border:1px solid #eef2f6; border-radius:6px; cursor:pointer; }
        .buttons { display:flex; gap:10px; margin-top:18px; border-top:1px solid #eceff3; padding-top:16px; }
        button { padding:10px 16px; border-radius:6px; border:0; font-weight:700; cursor:pointer; }
        .btn-primary { background:#003262; color:#fff; }
        .btn-muted { background:#eef2f6; color:#003262; }
        .btn-success { background:#2e7d32; color:#fff; }
        .error { background:#fff2f2; color:#c62828; padding:10px 12px; border-radius:6px; margin-bottom:12px; display:none; }
        .error.active { display:block; }
        .completion { text-align:center; display:none; padding:24px; }
        .completion.active { display:block; }
        
        /* Accessibility enhancements */
        .skip-link {
            position: absolute;
            top: -40px;
            left: 6px;
            background: #003262;
            color: white;
            padding: 8px;
            text-decoration: none;
            border-radius: 4px;
            z-index: 1000;
        }
        .skip-link:focus {
            top: 6px;
        }
        
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
        
        /* Focus styles */
        *:focus {
            outline: 2px solid #0066cc;
            outline-offset: 2px;
        }
        
        button:focus, input:focus, select:focus, textarea:focus {
            outline: 2px solid #0066cc;
            outline-offset: 2px;
        }
        
        /* High contrast mode support */
        @media (prefers-contrast: high) {
            .option {
                border: 2px solid #000;
            }
            .option:hover, .option:focus-within {
                background: #f0f0f0;
            }
        }
        
        /* Reduced motion support */
        @media (prefers-reduced-motion: reduce) {
            .progress > .bar {
                transition: none;
            }
            @keyframes fadeIn {
                from { opacity: 0; }
                to { opacity: 1; }
            }
        }
    </style>
</head>
<body>
    <a href="#main-content" class="skip-link">Skip to main content</a>
    
    <div class="container">
        <header class="header" role="banner">
            <h1>CSUF MPA — Exit Survey (Early Exit)</h1>
            <p>Your anonymous feedback helps improve retention and student experience.</p>
        </header>

        <main id="main-content" role="main">
            <div class="intro">
                Please answer the brief questions about why you left the MPA program. This form should take 5 minutes. Fields marked with * are required.
            </div>

            <div class="progress" role="progressbar" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100" aria-label="Form completion progress">
                <div class="bar" id="progressBar"></div>
                <div class="sr-only" id="progressText">Step 1 of 4 complete</div>
            </div>

            <div class="error" id="errorMessage" role="alert" aria-live="polite" aria-atomic="true"></div>
            <div class="sr-only" aria-live="polite" aria-atomic="true" id="announcements"></div>

            <form id="dropoutForm" action="https://formspree.io/f/mkgqekja" method="POST" novalidate>
                <!-- Section 1 -->
                <section class="section active" data-section="1" aria-labelledby="section1-heading">
                    <h2 id="section1-heading" style="color:#003262; margin-bottom:12px; font-size:18px;">1. Basic info</h2>

                    <div class="question">
                        <label for="name">Name (optional)</label>
                        <input type="text" id="name" name="name" placeholder="You may leave blank to remain anonymous" aria-describedby="name-help">
                        <div id="name-help" class="sr-only">This field is optional. Leave blank to remain anonymous.</div>
                    </div>

                    <div class="question">
                        <label for="email">Email (optional)</label>
                        <input type="email" id="email" name="email" placeholder="If you'd like follow-up (optional)" aria-describedby="email-help">
                        <div id="email-help" class="sr-only">This field is optional. Provide only if you want to be contacted for follow-up.</div>
                    </div>

                    <div class="question">
                        <label for="last_term" class="required">Last term enrolled (e.g., Fall 2024)</label>
                        <input type="text" id="last_term" name="last_term" required aria-describedby="last_term-help">
                        <div id="last_term-help" class="sr-only">Required field. Enter the last term you were enrolled, for example Fall 2024.</div>
                    </div>
                </section>

                <!-- Section 2 -->
                <section class="section" data-section="2" aria-labelledby="section2-heading">
                    <h2 id="section2-heading" style="color:#003262; margin-bottom:12px; font-size:18px;">2. Why did you leave?</h2>

                    <fieldset class="question">
                        <legend class="required">Primary reason for leaving</legend>
                        <div class="radio-group" role="radiogroup" aria-required="true">
                            <label class="option"><input type="radio" name="primary_reason" value="financial" required> Financial reasons/cost</label>
                            <label class="option"><input type="radio" name="primary_reason" value="time_conflict" required> Time/work/life conflict</label>
                            <label class="option"><input type="radio" name="primary_reason" value="academic_difficulty" required> Academic difficulty</label>
                            <label class="option"><input type="radio" name="primary_reason" value="program_mismatch" required> Program didn't meet expectations</label>
                            <label class="option"><input type="radio" name="primary_reason" value="advising_issues" required> Advising / administrative issues</label>
                            <label class="option"><input type="radio" name="primary_reason" value="health_personal" required> Health / personal reasons</label>
                            <label class="option"><input type="radio" name="primary_reason" value="other" required> Other (please specify)</label>
                        </div>
                        <input type="text" name="primary_reason_other" id="primaryOther" placeholder="If other, please specify" style="margin-top:10px; display:none;" aria-label="Other reason specification">
                    </fieldset>

                    <fieldset class="question">
                        <legend>Were financial aid/scholarships a factor?</legend>
                        <div class="radio-group" role="radiogroup">
                            <label class="option"><input type="radio" name="financial_aid_factor" value="yes"> Yes</label>
                            <label class="option"><input type="radio" name="financial_aid_factor" value="no"> No</label>
                            <label class="option"><input type="radio" name="financial_aid_factor" value="somewhat"> Somewhat</label>
                        </div>
                    </fieldset>
                </section>

                <!-- Section 3 -->
                <section class="section" data-section="3" aria-labelledby="section3-heading">
                    <h2 id="section3-heading" style="color:#003262; margin-bottom:12px; font-size:18px;">3. Program experience</h2>

                    <fieldset class="question">
                        <legend class="required">Rate these areas (Excellent / Good / Fair / Poor)</legend>
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                            <div>
                                <label for="rate_course_quality" style="font-weight:600; margin-bottom:6px;">Course quality</label>
                                <select id="rate_course_quality" name="rate_course_quality" required aria-describedby="course-quality-help">
                                    <option value="">Select rating</option>
                                    <option value="excellent">Excellent</option>
                                    <option value="good">Good</option>
                                    <option value="fair">Fair</option>
                                    <option value="poor">Poor</option>
                                </select>
                                <div id="course-quality-help" class="sr-only">Rate the quality of courses in the program</div>
                            </div>
                            <div>
                                <label for="rate_faculty_support" style="font-weight:600; margin-bottom:6px;">Faculty support</label>
                                <select id="rate_faculty_support" name="rate_faculty_support" required aria-describedby="faculty-support-help">
                                    <option value="">Select rating</option>
                                    <option value="excellent">Excellent</option>
                                    <option value="good">Good</option>
                                    <option value="fair">Fair</option>
                                    <option value="poor">Poor</option>
                                </select>
                                <div id="faculty-support-help" class="sr-only">Rate the level of support from faculty</div>
                            </div>
                            <div>
                                <label for="rate_advising" style="font-weight:600; margin-bottom:6px;">Advising / admin</label>
                                <select id="rate_advising" name="rate_advising" required aria-describedby="advising-help">
                                    <option value="">Select rating</option>
                                    <option value="excellent">Excellent</option>
                                    <option value="good">Good</option>
                                    <option value="fair">Fair</option>
                                    <option value="poor">Poor</option>
                                </select>
                                <div id="advising-help" class="sr-only">Rate the quality of academic advising and administration</div>
                            </div>
                            <div>
                                <label for="rate_program_fit" style="font-weight:600; margin-bottom:6px;">Program fit</label>
                                <select id="rate_program_fit" name="rate_program_fit" required aria-describedby="program-fit-help">
                                    <option value="">Select rating</option>
                                    <option value="excellent">Excellent</option>
                                    <option value="good">Good</option>
                                    <option value="fair">Fair</option>
                                    <option value="poor">Poor</option>
                                </select>
                                <div id="program-fit-help" class="sr-only">Rate how well the program fit your needs and expectations</div>
                            </div>
                        </div>
                    </fieldset>

                    <div class="question">
                        <label for="key_issue">Briefly describe any key issue that influenced your decision (optional)</label>
                        <textarea id="key_issue" name="key_issue" placeholder="Example: scheduling conflicts with work, unexpected costs, etc." aria-describedby="key-issue-help"></textarea>
                        <div id="key-issue-help" class="sr-only">Optional field to describe specific issues that influenced your decision to leave</div>
                    </div>
                </section>

                <!-- Section 4 -->
                <section class="section" data-section="4" aria-labelledby="section4-heading">
                    <h2 id="section4-heading" style="color:#003262; margin-bottom:12px; font-size:18px;">4. Suggestions & next steps</h2>

                    <div class="question">
                        <label for="suggestions" class="required">What could the program change to help retain students like you?</label>
                        <textarea id="suggestions" name="suggestions" required aria-describedby="suggestions-help"></textarea>
                        <div id="suggestions-help" class="sr-only">Required field. Provide suggestions for how the program could improve student retention</div>
                    </div>

                    <fieldset class="question">
                        <legend>Are you interested in being contacted to discuss your experience?</legend>
                        <div class="radio-group" role="radiogroup">
                            <label class="option"><input type="radio" name="contact_ok" value="yes"> Yes — you may contact me</label>
                            <label class="option"><input type="radio" name="contact_ok" value="no"> No — please do not contact</label>
                        </div>
                    </fieldset>

                    <div class="question" id="contactDetails" style="display:none;" aria-live="polite">
                        <div style="background:#f0f7ff; padding:12px; border-left:4px solid #003262; border-radius:6px; margin-bottom:12px;">
                            <strong>Contact Information</strong> — Please provide your details for follow-up:
                        </div>
                        
                        <div class="question" id="contactNameField" style="display:none;">
                            <label for="contact_name" class="required">Name</label>
                            <input type="text" id="contact_name" name="contact_name" placeholder="Your name for follow-up">
                        </div>

                        <div class="question" id="contactEmailField" style="display:none;">
                            <label for="contact_email" class="required">Email</label>
                            <input type="email" id="contact_email" name="contact_email" placeholder="Your email for follow-up">
                        </div>
                    </div>

                    <div style="background:#f0f7ff; padding:12px; border-left:4px solid #003262; border-radius:6px; margin-top:12px;">
                        <strong>Thank you.</strong> Submitting this form will send the responses to the program staff. You can also download a copy before submitting.
                    </div>
                </section>

                <nav class="buttons" role="navigation" aria-label="Form navigation">
                    <button type="button" class="btn-muted" id="prevBtn" style="display:none;" aria-describedby="prev-help">Previous</button>
                    <button type="button" class="btn-primary" id="nextBtn" aria-describedby="next-help">Next</button>
                    <button type="button" class="btn-success" id="submitBtn" style="display:none;" aria-describedby="submit-help">Submit</button>
                    <button type="button" class="btn-muted" id="downloadBtn" style="margin-left:auto;" aria-describedby="download-help">Download CSV</button>
                    <div class="sr-only">
                        <div id="prev-help">Go to previous section of the form</div>
                        <div id="next-help">Go to next section of the form</div>
                        <div id="submit-help">Submit the completed form</div>
                        <div id="download-help">Download your responses as a CSV file</div>
                    </div>
                </nav>
            </form>

            <div class="completion" id="completionMessage" role="alert" aria-live="polite">
                <h2 style="color:#2e7d32;">✓ Thank you — Response recorded</h2>
                <p style="color:#555;">We appreciate your feedback. If you agreed to be contacted, someone may follow up.</p>
                <button class="btn-success" id="completionDownload" aria-describedby="completion-download-help">Download Responses (CSV)</button>
                <div id="completion-download-help" class="sr-only">Download a copy of your submitted responses</div>
            </div>
        </main>
    </div>

    <script>
        // Shortened navigation & submission logic
        let current = 1;
        const total = 4;
        const data = {};

        document.addEventListener('DOMContentLoaded', () => {
            updateProgress();
            setup();
        });

        function setup() {
            document.getElementById('nextBtn').addEventListener('click', () => {
                if (validateSection()) {
                    saveSection();
                    if (current < total) { current++; showSection(current); updateProgress(); }
                }
            });

            document.getElementById('prevBtn').addEventListener('click', () => {
                if (current > 1) { saveSection(); current--; showSection(current); updateProgress(); }
            });

            document.getElementById('submitBtn').addEventListener('click', () => {
                if (validateSection()) {
                    saveSection();
                    submitForm();
                }
            });

            document.getElementById('downloadBtn').addEventListener('click', downloadCSV);
            document.getElementById('completionDownload').addEventListener('click', downloadCSV);

            // show/hide "other" input
            document.querySelectorAll('input[name="primary_reason"]').forEach(r => {
                r.addEventListener('change', () => {
                    const other = document.getElementById('primaryOther');
                    if (r.value === 'other' && r.checked) { other.style.display = 'block'; other.required = true; }
                    else if (!document.querySelector('input[name="primary_reason"][value="other"]')?.checked) { other.style.display = 'none'; other.value=''; other.required = false; }
                });
            });
            
            // show/hide contact details based on contact_ok selection
            document.querySelectorAll('input[name="contact_ok"]').forEach(r => {
                r.addEventListener('change', () => {
                    const contactDetails = document.getElementById('contactDetails');
                    const contactNameField = document.getElementById('contactNameField');
                    const contactEmailField = document.getElementById('contactEmailField');
                    const nameInput = document.querySelector('input[name="contact_name"]');
                    const emailInput = document.querySelector('input[name="contact_email"]');
                    
                    if (r.value === 'yes' && r.checked) {
                        contactDetails.style.display = 'block';
                        announceToScreenReader('Contact information section is now visible.');
                        
                        // Check if name/email were provided in section 1
                        const originalName = document.querySelector('input[name="name"]').value.trim();
                        const originalEmail = document.querySelector('input[name="email"]').value.trim();
                        
                        // Show name field if not provided originally
                        if (!originalName) {
                            contactNameField.style.display = 'block';
                            nameInput.required = true;
                        } else {
                            contactNameField.style.display = 'none';
                            nameInput.required = false;
                            nameInput.value = '';
                        }
                        
                        // Show email field if not provided originally
                        if (!originalEmail) {
                            contactEmailField.style.display = 'block';
                            emailInput.required = true;
                        } else {
                            contactEmailField.style.display = 'none';
                            emailInput.required = false;
                            emailInput.value = '';
                        }
                    } else {
                        contactDetails.style.display = 'none';
                        announceToScreenReader('Contact information section is now hidden.');
                        nameInput.required = false;
                        emailInput.required = false;
                        nameInput.value = '';
                        emailInput.value = '';
                    }
                });
            });

            // Keyboard navigation for radio groups
            document.querySelectorAll('.radio-group').forEach(group => {
                const radios = group.querySelectorAll('input[type="radio"]');
                radios.forEach((radio, index) => {
                    radio.addEventListener('keydown', (e) => {
                        if (e.key === 'ArrowDown' || e.key === 'ArrowRight') {
                            e.preventDefault();
                            const next = radios[(index + 1) % radios.length];
                            next.focus();
                            next.checked = true;
                            next.dispatchEvent(new Event('change'));
                        } else if (e.key === 'ArrowUp' || e.key === 'ArrowLeft') {
                            e.preventDefault();
                            const prev = radios[(index - 1 + radios.length) % radios.length];
                            prev.focus();
                            prev.checked = true;
                            prev.dispatchEvent(new Event('change'));
                        }
                    });
                });
            });
        }

        function showSection(n) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            const el = document.querySelector(`.section[data-section="${n}"]`);
            if (el) el.classList.add('active');
            document.getElementById('prevBtn').style.display = n>1 ? 'inline-block' : 'none';
            document.getElementById('nextBtn').style.display = n<total ? 'inline-block' : 'none';
            document.getElementById('submitBtn').style.display = n===total ? 'inline-block' : 'none';
            window.scrollTo({ top: 0, behavior: 'smooth' });
            
            // Update progress bar accessibility
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            const pct = (n / total) * 100;
            progressBar.parentElement.setAttribute('aria-valuenow', pct);
            progressText.textContent = `Step ${n} of ${total} complete`;
            
            // Announce section change
            const sectionHeading = document.querySelector(`[data-section="${n}"] h2`);
            if (sectionHeading) {
                announceToScreenReader(`Now on ${sectionHeading.textContent}`);
                // Focus the section heading for screen readers
                sectionHeading.setAttribute('tabindex', '-1');
                sectionHeading.focus();
                setTimeout(() => sectionHeading.removeAttribute('tabindex'), 100);
            }
        }

        function updateProgress() {
            const pct = (current / total) * 100;
            document.getElementById('progressBar').style.width = pct + '%';
        }

        function validateSection() {
            const sec = document.querySelector(`.section[data-section="${current}"]`);
            const reqs = Array.from(sec.querySelectorAll('[required]'));
            let ok = true;
            let first = null;

            hideError();
            reqs.forEach(f => {
                // ignore hidden
                if (f.offsetParent === null) return;
                if (f.type === 'radio') {
                    const group = sec.querySelectorAll(`[name="${f.name}"]`);
                    const checked = Array.from(group).some(r => r.checked);
                    if (!checked) { ok = false; if (!first) first = f; }
                } else if (!String(f.value || '').trim()) {
                    ok = false; if (!first) first = f;
                    f.style.borderColor = '#c62828';
                } else {
                    f.style.borderColor = '#ddd';
                }
            });

            if (!ok) {
                showError('Please complete all required fields on this page before continuing.');
                announceToScreenReader('Form validation failed. Please complete all required fields.');
                if (first) {
                    first.scrollIntoView({ behavior: 'smooth', block:'center' });
                    first.focus();
                }
            } else {
                announceToScreenReader('All required fields completed successfully.');
            }
            return ok;
        }

        function saveSection() {
            const sec = document.querySelector(`.section[data-section="${current}"]`);
            const inputs = sec.querySelectorAll('input,select,textarea');
            inputs.forEach(i => {
                if (!i.name) return;
                if (i.type === 'radio') {
                    if (i.checked) data[i.name] = i.value;
                } else if (i.type === 'checkbox') {
                    if (!data[i.name]) data[i.name] = [];
                    if (i.checked) data[i.name].push(i.value);
                } else {
                    data[i.name] = i.value;
                }
            });
            
            // If contact fields were filled, use them as the primary contact info
            if (data.contact_name && data.contact_name.trim()) {
                data.name = data.contact_name;
            }
            if (data.contact_email && data.contact_email.trim()) {
                data.email = data.contact_email;
            }
        }

        function submitForm() {
            // timestamp
            data.submission_date = new Date().toISOString();

            // prepare FormData
            const fd = new FormData();
            for (const k in data) {
                let v = data[k];
                if (Array.isArray(v)) v = v.join('; ');
                fd.append(k, v);
            }

            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true; submitBtn.textContent = 'Submitting...';
            announceToScreenReader('Submitting form, please wait...');

            fetch('https://formspree.io/f/mkgqekja', {
                method: 'POST',
                body: fd,
                headers: { 'Accept': 'application/json' }
            }).then(res => {
                if (res.ok) {
                    document.getElementById('dropoutForm').style.display = 'none';
                    document.querySelector('.progress').style.display = 'none';
                    document.getElementById('completionMessage').classList.add('active');
                    announceToScreenReader('Form submitted successfully. Thank you for your feedback.');
                    document.getElementById('completionMessage').focus();
                } else {
                    return res.json().then(j => { throw j; });
                }
            }).catch(() => {
                showError('Submission failed. You can download your responses and email them to program staff.');
                announceToScreenReader('Form submission failed. You can download your responses as a backup.');
                submitBtn.disabled = false; submitBtn.textContent = 'Submit';
            });
        }

        function convertToCSV(obj) {
            let csv = 'Field,Value\n';
            for (const k in obj) {
                let v = obj[k];
                if (Array.isArray(v)) v = v.join('; ');
                v = String(v || '').replace(/"/g,'""');
                if (v.includes(',')||v.includes('\n')) v = `"${v}"`;
                csv += `"${k}","${v}"\n`;
            }
            return csv;
        }

        function downloadCSV() {
            // ensure latest section saved
            saveSection();
            data.submission_backups = 'local_copy';
            const csv = convertToCSV(data);
            const blob = new Blob([csv], { type:'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'mpa_exit_dropout_' + Date.now() + '.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function showError(msg) {
            const e = document.getElementById('errorMessage');
            e.textContent = msg; e.classList.add('active'); e.scrollIntoView({ behavior:'smooth', block:'center' });
        }
        function hideError() {
            const e = document.getElementById('errorMessage'); e.classList.remove('active');
        }

        function announceToScreenReader(message) {
            const announcements = document.getElementById('announcements');
            announcements.textContent = message;
            // Clear after announcement
            setTimeout(() => announcements.textContent = '', 1000);
        }
    </script>
</body>
</html>